- name: Change Source node hostname
  hostname:
    name: pcsm-source
  when: inventory_hostname == "keith-pcsm-source"

- name: Change Destination node hostname
  hostname:
    name: pcsm-destination
  when: inventory_hostname == "keith-pcsm-destination"

- name: Change PCSM node hostname
  hostname:
    name: pcsm-clustersync
  when: inventory_hostname == "keith-pcsm-clustersync"

- name: Prerequisite for debian 11
  apt:
    name: iproute2
    update_cache: yes
  when: ansible_distribution == "Debian" and ansible_distribution_major_version >= "11"

- name: Install deps
  yum:
    name: "{{ packages }}"
    state: present
    update_cache: yes
  vars:
    packages:
    - jq
    - vim
    - zlib-devel
    - libjpeg-devel
    - freetype-devel
    - gcc
    - python3-devel
    - python3.12
    - python3-pip
    - make
    - wget
    - git
  when: ansible_os_family == "RedHat"

- name: Install deps
  apt:
    name: "{{ packages }}"
    state: present
    update_cache: yes
  vars:
    packages:
    - jq
    - vim
    - zlib1g-dev
    - libjpeg-dev
    - libfreetype6-dev
    - gcc
    - python3-dev
    - python3.12
    - python3-pip
    - make
    - wget
    - git
    - iputils-ping
  when: ansible_os_family == "Debian"

- name: Install Go from official tarball on PCSM host
  vars:
    go_version: "{{ golang_version }}"
    go_tarball: "go{{ go_version }}.linux-amd64.tar.gz"
    go_url: "https://go.dev/dl/{{ go_tarball }}"
    go_install_dir: "/usr/local"
  block:
    - name: Download Go {{ go_version }}
      get_url:
        url: "{{ go_url }}"
        dest: "/tmp/{{ go_tarball }}"
        mode: '0644'

    - name: Extract Go
      unarchive:
        src: "/tmp/{{ go_tarball }}"
        dest: "{{ go_install_dir }}"
        remote_src: yes
  when: inventory_hostname == "keith-pcsm-clustersync" or inventory_hostname == "keith-pcsm-source"

- name: Check Go is available
  command: go version
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"
  register: go_version_output
  ignore_errors: true
  when: inventory_hostname == "keith-pcsm-clustersync" or inventory_hostname == "keith-pcsm-source"

- name: Install Pymongo for Redhat
  pip:
    name:
      - pymongo
  when: ansible_facts['os_family'] == 'RedHat'

- name: Install Pymongo on Debian
  command: python3 -m pip install --break-system-packages pymongo
  when: ansible_facts['os_family'] == 'Debian'

- name: Clone PCSM repo
  timeout: 180
  git:
    repo: 'https://github.com/percona/percona-clustersync-mongodb.git'
    dest: /tmp/percona-clustersync-mongodb
    version: "{{ pcsm_branch }}"
  when: inventory_hostname == "keith-pcsm-clustersync"

- name: Build PCSM
  command: make build
  args:
    chdir: /tmp/percona-clustersync-mongodb
  environment:
    PATH: /usr/local/go/bin:{{ ansible_env.PATH }}
    GOROOT: /usr/local/go/
    GOBIN: /usr/local/go/bin
  when: inventory_hostname == "keith-pcsm-clustersync"

- name: Move PCSM binary to /usr/local/bin
  copy:
    src: /tmp/percona-clustersync-mongodb/bin/pcsm
    dest: /usr/local/bin/
    mode: '0775'
    remote_src: true
  when: inventory_hostname == "keith-pcsm-clustersync"

- name: Clone Mgodatagen repo
  git:
    repo: 'https://github.com/feliixx/mgodatagen.git'
    dest: /tmp/mgodatagen
    version: "master"
  when: inventory_hostname == "keith-pcsm-source"

- name: Build Mgodatagen
  command: go build
  args:
    chdir: /tmp/mgodatagen
  environment:
    PATH: /usr/local/go/bin:{{ ansible_env.PATH }}
    GOROOT: /usr/local/go/
    GOBIN: /usr/local/go/bin
  when: inventory_hostname == "keith-pcsm-source"

- name: Move mgodatagen binary to /usr/local/bin
  copy:
    src: /tmp/mgodatagen/
    dest: /usr/local/bin/
    mode: '0755'
    remote_src: true
  when: inventory_hostname == "keith-pcsm-source"

- name: Copy load_data.py to /tmp
  copy:
    src: ../scripts/load_data.py
    dest: /tmp/load_data.py
    mode: '0755'

- name: Get private source ip address
  set_fact:
    private_source_ip: "{{ hostvars['keith-pcsm-source']['ansible_default_ipv4']['address'] }}"

- name: Get private destination ip address
  set_fact:
    private_destination_ip: "{{ hostvars['keith-pcsm-destination']['ansible_default_ipv4']['address'] }}"

- name: Get private pcsm ip address
  set_fact:
    private_clustersync_ip: "{{ hostvars['keith-pcsm-clustersync']['ansible_default_ipv4']['address'] }}"

- name: Show source IP (Debug)
  debug:
    var: private_source_ip
  when: private_source_ip is defined and inventory_hostname == "keith-pcsm-source"

- name: Show destination IP (Debug)
  debug:
    var: private_destination_ip
  when: private_destination_ip is defined and inventory_hostname == "keith-pcsm-destination"

- name: Show Clustersync IP (Debug)
  debug:
    var: private_clustersync_ip
  when: private_clustersync_ip is defined and inventory_hostname == "keith-pcsm-clustersync"

- name: Add source and destination to /etc/hosts in pcsm
  blockinfile:
    path: /etc/hosts
    block: |
      {{ private_source_ip }}    source
      {{ private_clustersync_ip }}    destination
    create: false
    unsafe_writes: true
  when: inventory_hostname == "keith-pcsm-clustersync"

- name: Install GPG key for epel 8
  rpm_key:
    state: present
    key: https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-8
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version == "8"

- name: Install GPG key for Percona repos
  rpm_key:
    state: present
    key: https://repo.percona.com/yum/RPM-GPG-KEY-Percona
  when: ansible_os_family == "RedHat"

- name: Install Percona Release package on Debian
  apt:
    deb: https://repo.percona.com/apt/percona-release_latest.generic_all.deb
  when: ansible_os_family == "Debian" and inventory_hostname in groups['psmdb']

- name: Install latest percona-release RHEL
  command: yum -y install https://repo.percona.com/yum/percona-release-latest.noarch.rpm
  when: ansible_os_family == "RedHat" and inventory_hostname in groups['psmdb']

- name: setup psmdb repo with percona-release
  command: percona-release enable psmdb-{{ psmdb_version }}0 release
  when: inventory_hostname in groups['psmdb']

- name: Install psmdb deb packages
  apt:
    name: "{{ packages }}"
    update_cache: yes
    state: latest
  vars:
    packages:
    - percona-server-mongodb
    - percona-server-mongodb-server
    - percona-server-mongodb-mongos
    - percona-server-mongodb-tools
  when: ansible_os_family == "Debian" and inventory_hostname in groups['psmdb']

- name: Install latest psmdb rpm packages on redhat
  yum:
    name: "{{ packages }}"
    update_cache: yes
    state: latest
  vars:
    packages:
    - percona-server-mongodb
    - percona-server-mongodb-server
    - percona-server-mongodb-mongos
    - percona-server-mongodb-tools
  when: ansible_os_family == "RedHat" and inventory_hostname in groups['psmdb']

- name: Install mongosh deb package
  apt:
    name: "{{ packages }}"
    update_cache: yes
  vars:
    packages:
    - percona-mongodb-mongosh
  when: ansible_os_family == "Debian" and inventory_hostname in groups['psmdb']

- name: Install mongosh rpm package
  yum:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
    - percona-mongodb-mongosh
  when: ansible_os_family == "RedHat" and inventory_hostname in groups['psmdb']

- name: Copy mongosh binary to mongo path for test scripts
  file:
    src: /usr/bin/mongosh
    dest: /usr/bin/mongo
    state: link
  when: inventory_hostname in groups['psmdb']

- name: stop mongod service
  service: name=mongod state=stopped
  when: inventory_hostname in groups['psmdb']

- name: Create data directory for mongod
  file:
    path: /mnt/data/db
    state: directory
    mode: '0755'
    owner: mongod
    group: mongod
  when: inventory_hostname in groups['psmdb']

- name: Switch mongod to new dbPath
  replace:
    path: /etc/mongod.conf
    regexp: '^  dbPath: /var/lib/mongo(?:db)?'
    replace: '  dbPath: /mnt/data/db'
  when: inventory_hostname in groups['psmdb']