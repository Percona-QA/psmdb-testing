FROM easyrsa/local AS easyrsa

FROM quay.io/keycloak/keycloak:latest

ENV KEYCLOAK_ADMIN=admin
ENV KEYCLOAK_ADMIN_PASSWORD=admin

COPY --from=easyrsa --chown=keycloak /etc/keycloak/keycloak.crt /opt/keycloak/conf/server.crt.pem
COPY --from=easyrsa --chown=keycloak /etc/keycloak/keycloak.key /opt/keycloak/conf/server.key.pem

RUN mkdir -p /opt/keycloak/data/import
RUN cat > /opt/keycloak/data/import/test-realm.json <<'JSON'
{
  "realm": "test",
  "enabled": true,
  "sslRequired": "external",

  "roles": {
    "realm": [
      { "name": "mongodb.readWrite", "description": "Sample realm role for MongoDB access" }
    ]
  },

  "groups": [
    {
      "name": "testers",
      "realmRoles": [ "mongodb.readWrite" ]
    }
  ],

  "clients": [
    {
      "clientId": "test-app",
      "protocol": "openid-connect",
      "publicClient": true,
      "redirectUris": [
        "http://localhost:27097/redirect",
        "https://localhost:*/*",
        "https://keycloak:*/*",
        "*"
      ],
      "webOrigins": ["*"],
      "standardFlowEnabled": true,
      "directAccessGrantsEnabled": true,
      "attributes": { "pkce.code.challenge.method": "S256" },

      "protocolMappers": [
        {
          "name": "groups",
          "protocol": "openid-connect",
          "protocolMapper": "oidc-group-membership-mapper",
          "consentRequired": false,
          "config": {
            "full.path": "false",
            "access.token.claim": "true",
            "id.token.claim": "true",
            "userinfo.token.claim": "true",
            "claim.name": "groups",
            "jsonType.label": "String"
          }
        },
        {
          "name": "email",
          "protocol": "openid-connect",
          "protocolMapper": "oidc-usermodel-property-mapper",
          "consentRequired": false,
          "config": {
            "user.attribute": "email",
            "claim.name": "email",
            "jsonType.label": "String",
            "access.token.claim": "true",
            "id.token.claim": "true",
            "userinfo.token.claim": "true"
          }
        },
        {
          "name": "preferred_username",
          "protocol": "openid-connect",
          "protocolMapper": "oidc-usermodel-property-mapper",
          "consentRequired": false,
          "config": {
            "user.attribute": "username",
            "claim.name": "preferred_username",
            "jsonType.label": "String",
            "access.token.claim": "true",
            "id.token.claim": "true",
            "userinfo.token.claim": "true"
          }
        },
        {
          "name": "realm roles",
          "protocol": "openid-connect",
          "protocolMapper": "oidc-usermodel-realm-role-mapper",
          "consentRequired": false,
          "config": {
            "claim.name": "realm_access.roles",
            "jsonType.label": "String",
            "multivalued": "true",
            "access.token.claim": "true",
            "id.token.claim": "false",
            "userinfo.token.claim": "false"
          }
        }
      ]
    },

    {
      "clientId": "test-confidential",
      "protocol": "openid-connect",
      "publicClient": false,
      "serviceAccountsEnabled": true,
      "redirectUris": ["*"],
      "webOrigins": ["*"],
      "standardFlowEnabled": true,
      "directAccessGrantsEnabled": true,
      "secret": "test-secret"
    },

    {
      "clientId": "pbmclient",
      "protocol": "openid-connect",
      "publicClient": false,
      "serviceAccountsEnabled": true,
      "redirectUris": ["*"],
      "webOrigins": ["*"],
      "standardFlowEnabled": false,
      "directAccessGrantsEnabled": false,
      "secret": "pbm-secret",

      "protocolMappers": [
        {
          "name": "groups",
          "protocol": "openid-connect",
          "protocolMapper": "oidc-group-membership-mapper",
          "consentRequired": false,
          "config": {
            "full.path": "false",
            "access.token.claim": "true",
            "id.token.claim": "false",
            "userinfo.token.claim": "false",
            "claim.name": "groups",
            "jsonType.label": "String"
          }
        },
        {
          "name": "realm roles",
          "protocol": "openid-connect",
          "protocolMapper": "oidc-usermodel-realm-role-mapper",
          "consentRequired": false,
          "config": {
            "claim.name": "realm_access.roles",
            "jsonType.label": "String",
            "multivalued": "true",
            "access.token.claim": "true",
            "id.token.claim": "false",
            "userinfo.token.claim": "false"
          }
        }
      ]
    }
  ],

  "users": [
    {
      "username": "test",
      "enabled": true,
      "email": "test@example.test",
      "emailVerified": true,
      "groups": ["testers"],
      "credentials": [
        { "type": "password", "value": "testpass", "temporary": false }
      ]
    },
    {
      "username": "pbmuser",
      "enabled": true,
      "email": "pbmuser@example.test",
      "emailVerified": true,
      "credentials": [
        { "type": "password", "value": "pbmpass", "temporary": false }
      ]
    }
  ]
}
JSON

CMD ["start-dev","--https-certificate-file=/opt/keycloak/conf/server.crt.pem","--https-certificate-key-file=/opt/keycloak/conf/server.key.pem","--hostname=keycloak","--hostname-strict=false","--import-realm"]
