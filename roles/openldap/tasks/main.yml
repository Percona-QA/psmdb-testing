---
- include_vars: all.yml
- include_vars: "Debian-vars.yml"
  when: ansible_os_family == "Debian"
- include_vars: "RedHat-vars.yml"
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version <= "7"
- include_vars: "RedHat8-vars.yml"
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int >= 8

- name: Ensure venv tools present
  become: true
  ansible.builtin.apt:
    name:
      - python3-venv
      - python3-full   # ensures venv has pip
    state: present
    update_cache: true

- name: Create virtualenv for Ansible deps
  become: true
  ansible.builtin.command: python3 -m venv /opt/ansible-venv
  args:
    creates: /opt/ansible-venv/bin/activate

- name: Install Python packages into the venv
  become: true
  ansible.builtin.pip:
    name:
      - requests
      - docker
    virtualenv: /opt/ansible-venv
    virtualenv_python: python3
    state: present

# Tell subsequent tasks to use the venvâ€™s Python (so docker SDK is found)
- name: Set interpreter to the venv for the rest of the play
  ansible.builtin.set_fact:
    ansible_python_interpreter: /opt/ansible-venv/bin/python

- name: Ensure Docker network exists
  community.docker.docker_network:
    name: test
    driver: bridge
    state: present

- name: Remove any existing container
  community.docker.docker_container:
    name: ldap
    state: absent
    keep_volumes: false

- name: Copy entire ldif directory to host
  ansible.builtin.copy:
    src: templates
    dest: /tmp/ldifs/
    mode: "0644"
    directory_mode: "0755"

- name: Run OpenLDAP container
  docker_container:
    name: ldap
    image: bitnamilegacy/openldap:latest
    restart_policy: unless-stopped
    hostname: ldap
    published_ports:
      - "389:1389"
      - "1636:1636"
    env:
      LDAP_ROOT: "dc=percona,dc=com"
      LDAP_ADMIN_USERNAME: "admin"
      LDAP_ADMIN_PASSWORD: "secret"
      LDAP_SKIP_DEFAULT_TREE: "yes"
      LDAP_CUSTOM_LDIF_DIR: /tmp/ldifs/templates
    volumes: /tmp/ldifs:/tmp/ldifs:ro
    networks:
      - name: test
