---
- name: Download packages to localhost
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - set_fact:
        tarball: "{{ lookup('env', 'TARBALL') | default('https://downloads.percona.com/downloads/TESTING/psmdb-6.0.16/percona-server-mongodb-6.0.16-13-x86_64.glibc2.17-minimal.tar.gz', true) }}"

    - name: Get tarball template
      set_fact:
        tarball_template: "{{ tarball | regex_replace('glibc.+', '') }}"

    - name: Debug tarball tarball template
      debug:
        msg: "{{ tarball_template }}"

    - name: Get mongodb version
      set_fact:
        mongodb_ver: "{{ tarball | regex_search('mongodb-([0-9]+\\.[0-9]+\\.[0-9]+)', '\\1') }}"

    - name: Get mongodb major version
      set_fact:
        maj_version={{ mongodb_ver[0].split('.')[0] }}

    - name: Debug mongodb major version
      debug:
        msg: "{{ maj_version }}"

    - name: Detect FCV
      set_fact:
        fcv: "{{ mongodb_ver[0].split('.')[0] }}.{{ mongodb_ver[0].split('.')[1] }}"

    - name: Get git repo branch
      set_fact:
        repo_branch: "v{{ mongodb_ver[0].split('.')[0] }}.{{ mongodb_ver[0].split('.')[1] }}"

    - name: Debug repo branch
      debug:
        msg: "{{ repo_branch }}"

    - name: Download tarball from url
      get_url:
        url: '{{ tarball_template }}{{ item }}-minimal.tar.gz'
        dest: /tmp/percona-server-mongodb-{{mongodb_ver[0]}}-{{ item }}.tar.gz
        mode: '0644'
      loop:
        - ol7
        - ol8
        - ol9
        - ol2023
        - jammy
        - focal
        - noble
        - buster
        - bookworm
        - bullseye
      when: tarball.startswith('http')
      ignore_errors: yes

    - name: Download tarball from s3
      aws_s3:
        bucket: "{{ tarball_template | urlsplit('hostname') }}"
        object: "{{ tarball_template | urlsplit('path') }}{{ item }}-minimal.tar.gz"
        dest: /tmp/percona-server-mongodb-{{mongodb_ver[0]}}-{{ item }}.tar.gz
        mode: get
      loop:
        - ol7
        - ol8
        - ol9
        - ol2023
        - jammy
        - focal
        - noble
        - buster
        - bookworm
        - bullseye
      when: tarball.startswith('s3')
      ignore_errors: yes

    - name: Detect last-lts
      set_fact:
        last_lts: "{{ item }}"
      loop:
        - "4.4"
        - "5.0"
        - "6.0"
        - "7.0"
        - "8.0"
      when:
        - ( fcv == "9.0" and item == "8.0" ) or
          ( fcv == "8.0" and item == "7.0" ) or
          ( fcv == "7.0" and item == "6.0" ) or
          ( fcv == "6.0" and item == "5.0" ) or
          ( fcv == "5.0" and item == "4.4" )

    - debug:
        var: last_lts

    - name: Query latest last-lts version
      uri:
        url: https://www.percona.com/products-api.php
        method: POST
        body_format: form-urlencoded
        body:
          version: percona-server-mongodb-{{ last_lts }}
        return_content: true
      register: result

    - name: Debug result
      debug:
        var: result.content

    - name: Parse latest last-lts version
      set_fact:
        psmdb_last_lts: "{{ result.content|regex_replace('<option>-- Select version --</option><option value=[^>]*>([^<]*)</option>.*', '\\1')}}"

    #output be like percona-server-mongodb-5.0.29-25
    - debug:
        var: psmdb_last_lts

    #generate uri for last_lts
    #https://downloads.percona.com/downloads/percona-server-mongodb-7.0/percona-server-mongodb-7.0.18-11/binary/tarball/percona-server-mongodb-7.0.18-11-x86_64.focal-minimal.tar.gz
    - name: Download last_lts tarball from url
      get_url:
        url: 'https://downloads.percona.com/downloads/percona-server-mongodb-{{ last_lts }}/{{ psmdb_last_lts }}/binary/tarball/{{ psmdb_last_lts }}-x86_64.{{ item }}-minimal.tar.gz'
        dest: /tmp/percona-server-mongodb-{{ last_lts }}-{{ item }}.tar.gz
        mode: '0644'
      loop:
        - ol7
        - ol8
        - ol9
        - ol2023
        - jammy
        - focal
        - noble
        - buster
        - bookworm
        - bullseye
      ignore_errors: yes


- name: Converge
  hosts: all
  become: true
  become_method: sudo
  gather_facts: yes
  roles:
    - role: psmdb-tarball
    - role: '../../../roles/kmip'
    - role: '../../../roles/openldap'
    - role: '../../../roles/kerberos'
    - role: '../../../roles/vault'
