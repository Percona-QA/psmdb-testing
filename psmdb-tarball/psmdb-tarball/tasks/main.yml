---
- set_fact:
    tarball: "{{ lookup('env', 'TARBALL') | default('https://downloads.percona.com/downloads/percona-server-mongodb-4.2/percona-server-mongodb-4.2.15-16/binary/tarball/percona-server-mongodb-4.2.15-16-x86_64.glibc2.17-minimal.tar.gz', true) }}"

- name: Get mongodb version
  set_fact:
    mongodb_ver: "{{ tarball | regex_search('mongodb-([0-9]+\\.[0-9]+\\.[0-9]+)', '\\1') }}"

- name: Get git repo branch
  set_fact:
    repo_branch: "{{ tarball | regex_search('mongodb-([0-9]+\\.[0-9]+)', '\\1') }}"

- name: Copy tarball
  copy:
    src: /tmp/percona-server-mongodb-new-{{mongodb_ver[0]}}.tar.gz
    dest: /tmp/percona-server-mongodb-new.tar.gz
    mode: '0644'

- name: Unpack new tarball
  unarchive: 
    src: /tmp/percona-server-mongodb-new.tar.gz
    dest: /                     
    remote_src: yes
    extra_opts:
    - --transform
    - 's,^/*[^/]*,/usr,S'

- name: Clone PSMDB repo
  git:
    repo: 'https://github.com/percona/percona-server-mongodb.git'
    dest: /percona-server-mongodb               
    version: "v{{ repo_branch[0] }}"

- name: Create mongod symlink inside the workdir for 4.2 support
  file:
    src: /usr/bin/mongod
    dest: /percona-server-mongodb/mongod
    state: link

- name: Create mongo cli symlink inside the workdir for 4.2 support
  file:
    src: /usr/bin/mongo                       
    dest: /percona-server-mongodb/mongo
    state: link

#- name: Install software deps
#  command: ./psmdb_builder.sh --builddir=/tmp --install_deps=1
#  args:
#    chdir: /percona-server-mongodb/percona-packaging/scripts

- name: Install system packages
  become: true
  package:
     name:
       - python-setuptools
       - python3
       - python3-devel
       - python3-pip
     state: present

- name: Upgrade pip
  command: pip3 install --upgrade pip

- name: Install pip deps
  command: pip3 install -r etc/pip/dev-requirements.txt
  args:
    chdir: /percona-server-mongodb

- name: Hotfix for cryptography module
  command: pip3 install --upgrade cryptography==36.0.2

